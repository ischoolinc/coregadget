<!DOCTYPE html>
<html ng-app="gradebook">

<head>
    <meta http-equiv="Content-Type"
          content="text/html; charset=utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
    <script src="js/gadget.js"></script>
    <script>
        init({
            //application: "test.kh.edu.tw", 
            // "dev.jh_kh",//"test.kh.edu.tw",//
             application: "test.kh.edu.tw", 
            paramValues: {
                "DefaultRound": "2" //預設小數點位數
                //"第一次期中考Round": "1",
                //"第二次期中考Round": "2",
                //"期末考Round": "7",
                //"試算Round": "1", //指定評量項目小數點位數
                //"學期成績Round": "2"
            },
            oAuth: {
                clientID: 'b88fbfbbaa848c5b5b01ce51853eac7f',
                clientSecret: '0911245ae08323086790244cd319c1c3bbde1096520154f0cbcb71f0ff76e311',
                account:'',
                password :''
            }
        });
    </script>

    <title>GradeBook</title>
    <link rel="stylesheet"
          href="css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
    <link rel="stylesheet"
          href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
          integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="css/font-awesome.min.css" />
    <link rel="stylesheet"
          href="css/base.css" />
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script>
        $(function () {
            var newEditor = $("#gadget .hidden-xs").find("div").eq(0).clone();
            newEditor.css({ position: "", float: "", width: "" }).addClass('visible-xs');
            newEditor.find("table").eq(0).removeAttr("bs-affix").removeAttr("data-offset-top").removeAttr("style");
            newEditor.find("table").eq(0).find("tbody").eq(0).prepend(newEditor.find("table").eq(0).find("tbody").eq(0).find("tr").eq(1));
            $("#gadget").append(newEditor);
        });
    </script>
    <script src="js/angular.min.js"></script>
    <script src="js/sortable.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/xml2json.js"></script>
    <script src="js/angular-strap.min.js"></script>
    <script src="js/angular-strap.tpl.min.js"></script>
    <script src="js/gradebook.js"></script>
    <script src="js/xlsx.full.min.js"></script>
    <script src="js/FileSaver.js"></script>
    <script src="js/polyfill.min.js"></script>
    <style>
        .dropdown-header {
            padding: 3px 10px;
            font-size: 14px;
        }

        .importStudentPreview {
            padding: 5px 10px;
            border-radius: .25em;
            border: solid 1px lightgray;
            margin: 3px 0px;
        }

        .importStudentPreview .studentInfo {}

        .my-page {}
    </style>
</head>

<body ng-controller="MainCtrl">
    <div id="mainMsg"></div>

    <div ng-if="!(current && studentList && examList || haveNoCourse)||isloading "
         style="position:absolute;top:50%;left:50%;margin-top:-20px;margin-left:-50px;">Loading...</div>
    <div ng-if="(haveNoCourse) "
         style="position:absolute;top:50%;left:50%;margin-top:-20px;margin-left:-50px;">
        本學期沒有設定任何課程，請洽教務處行政人員</div>
    <div id="gadget"
         class="my-page"
         ng-if="current && studentList && examList && !isloading">
        <h1 class="hidden-xs">{{current.mode}}</h1>
        <div>
            <!--課程按鈕-->
            <div class="btn-group">
                <a href=""
                   class="btn btn-default dropdown-toggle"
                   data-toggle="dropdown">{{current.Course.CourseName}}&nbsp;<span class="caret"></span> </a>
                <ul class="dropdown-menu">
                    <li ng-repeat="course in courseList"
                        ng-class="{active:course==current.Course}">
                        <a href="javascript:;"
                           ng-click="setCurrentCourse(course)">{{course.CourseName}}</a>
                    </li>
                </ul>
            </div>
            <!--模式切換：成績管理、平時評量-->
            <!-- <div class="btn-group">
                <a class="btn btn-default dropdown-toggle"
                   data-toggle="dropdown">{{current.mode}}&nbsp;<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li ng-repeat="mode in modeList"
                        ng-class="{'active':mode == current.mode}">
                        <a href="javascript:;"
                           ng-click="setCurrentMode(mode)">{{mode}}</a>
                    </li>
                </ul>
            </div> -->
            <div class="btn-group"
                 role="group">
                <button type="button"
                        class="btn btn-default"
                        ng-class="{'active':mode == current.mode}"
                        ng-repeat="mode in modeList"
                        ng-click="setCurrentMode(mode)">{{mode}}</button>
            </div>
            <!--成績管理：匯出報表-->
            <div class="btn btn-default"
                 ng-if="current.mode == modeList[0]">
                <i class="far fa-file-excel"
                   ng-click="exportExcel()">
                    匯出報表
                </i>
            </div>

            <!--成績管理：匯出報表-->
            <div class="btn btn-default"
                 ng-if="current.mode === '平時評量'">
                <i class="far fa-file-excel"
                   ng-click="exportExcelA()">
                    匯出報表
                </i>
            </div>
            <!--批次 儲存-->
            <div class="btn-group pull-right">
                <div class="btn-group"
                     ng-if="batchItemList">
                    <a href=""
                       class="btn btn-default dropdown-toggle"
                       data-toggle="dropdown">
                        <i class="fa fa-cog"
                           aria-hidden="true"></i>
                        <span>批次</span>
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li ng-repeat="item in batchItemList"
                            ng-if="!item.Hide"
                            ng-class="{'disabled':item.Disabled,'dropdown-header':item.Type=='Header'}"
                            ng-style="item.Type=='Header'?'padding-left:10px;':''">
                            <span ng-if="item.Type=='Header'">
                                {{item.Name}}
                            </span>                           
                            <a ng-if="item.Type=='Function'"
                               href="javascript:;"
                               ng-click="(item.Type!='Function'||item.Disabled)?'':item.Fn()">
                                {{item.Name}} 
                            </a>
                            <a ng-if="item.Type=='Function_Effort'"
                               href="javascript:;"
                               style="font-size:smaller; padding-left:40px"
                               ng-click="(item.Type!='Function_Effort'||item.Disabled)?'':item.Fn()">
                                {{item.Name}}
                            </a>
                        </li>
                    </ul>
                </div>
                <a ng-click="save()"
                   class="btn btn-default"
                   ng-class="{'btn-danger':!IsNoChange()}"
                   ng-disabled ="isSaving">
                    <i class="fa fa-floppy-o"></i>
                    儲存 
                </a>
            </div>
            <!--平時評量: 編輯評分項目-->
            <div class="btn-group pull-right"
                 ng-if="current.mode == modeList[1]">
                <a class="btn btn-default"
                   ng-click="showGradeItemConfig()"
                  >
                    <i class="fa fa-edit">
                        編輯評分項目
                    </i>
                </a>
            </div>
        </div>
        <div style="clear: both;  margin-top: 8px"
             ng-if="current.mode !=='平時評量'">
            <span>{{current.Course.SchoolYear}}學年度 第{{current.Course.Semester}}學期 </span>
            開放時間：
            <span style="color: red"
                  ng-show="current.Exam.InputStartTime && current.Exam.InputEndTime">
                {{current.Exam.InputStartTime || '未指定'}} ~ {{current.Exam.InputEndTime || '未指定'}}
            </span>
            <!-- 2022/12/07 Cynthia 和佳樺討論，若使用者未指定評量，則如果現在時間在某次評量輸入時間範圍內，就顯示那個時間範圍 -->
            <span ng-show="!current.Exam && !current.Exam">{{defaultDate}}</span>
            <span ng-show="!current.Exam.InputStartTime && !current.Exam.InputEndTime">未開放</span>
            <span  style=" float: right; width: auto; color :#D83A56" > 若缺考為0分者，請記得輸入0分</span>
        </div>

        <div style="clear: both;  margin-top: 8px"
             ng-if="current.mode ==='平時評量'">
            <span>{{current.Course.SchoolYear}}學年度 第{{current.Course.Semester}}學期 </span>
            開放時間：
            <span style="color: red"
                  ng-show="current.Course.TemplateExtension.Extension.OrdinarilyStartTime && current.Course.TemplateExtension.Extension.OrdinarilyEndTime">
                {{current.Course.TemplateExtension.Extension.OrdinarilyStartTime || '未指定'}} ~ {{current.Course.TemplateExtension.Extension.OrdinarilyEndTime || '未指定'}}
            </span>
            <span ng-show="!current.Course.TemplateExtension.Extension.OrdinarilyStartTime && !current.Course.TemplateExtension.Extension.OrdinarilyEndTime">未開放</span>

            <span  style=" float: right; width: auto; color :#D83A56" > 若缺考為0分者，請記得輸入0分</span>
        </div>

        <div class="hidden-xs"
             ng-if="studentList"
             style="margin-top:10px;">
            <div style="position:relative;float:right;width:260px;">
                <div data-offset-top="145"
                     bs-affix>
                    <!-- 成績輸入 -->
                    <table class="table table-bordered table-striped"
                           style="width:260px;">
                        <thead>
                            <tr>
                                <th colspan="2">成績輸入</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width:95px;">
                                    <div class="btn-group btn-block">
                                        <a href=""
                                           class="btn btn-link btn-block dropdown-toggle"
                                           data-toggle="dropdown"
                                           style="padding:0; color:#333; text-align:left;">
                                            {{current.SelectMode=='No.'?"座號搜尋":"切換學生"}}
                                            <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu"
                                            style="width:100%;">
                                            <li ng-class="{active:current.SelectMode=='No.'}">
                                                <a href="javascript:;"
                                                   ng-click="changeSelectMode('No.')">座號搜尋</a>
                                            </li>
                                            <li ng-class="{active:current.SelectMode=='Seq.'}">
                                                <a href="javascript:;"
                                                   ng-click="changeSelectMode('Seq.')">切換學生</a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                                <td class="text-center"
                                    style="padding:0px;">
                                    <div ng-if="current.SelectMode=='No.'"
                                         class="input-group">
                                        <input ng-model="current.SelectSeatNo"
                                               ng-keydown="submitStudentNo($event)"
                                               ng-change="typeStudentNo()"
                                               ng-class="{disabled:!current.Student}"
                                               type="text"
                                               placeholder="{{isMobile?'':'Enter送出'}}"
                                               class="form-control pg-seatno-textbox"
                                               select-on-click />
                                        <span class="input-group-btn">
                                            <a ng-click="submitStudentNo()"
                                               class="btn btn-default">
                                                送出
                                            </a>
                                        </span>
                                    </div>

                                    <div ng-if="current.SelectMode=='Seq.'"
                                         class="btn-group btn-group-sm">
                                        <a class="btn btn-default"
                                           ng-click="goPrev()">
                                            &nbsp;&nbsp;&nbsp; << &nbsp;&nbsp;&nbsp;
                                               </a> <a class="btn btn-default"
                                                   ng-click="goNext()">
                                                    &nbsp;&nbsp;&nbsp; >> &nbsp;&nbsp;&nbsp;
                                                </a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>目前學生</td>
                                <td>
                                    <span ng-if="current.Student.ClassName">
                                   {{current.Student.ClassName}}   
                                        <span ng-if="current.Student.SeatNo">({{current.Student.SeatNo}})</span>
                                    </span>
                                    <span>
                                    <b>{{current.Student.StudentName}}</b>    
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr>
                                <th colspan="2">
                                    <div class="btn-group btn-block">
                                        <a href="javascript:void(0)"
                                           class="btn btn-link btn-block dropdown-toggle"
                                           data-toggle="dropdown"
                                           style="padding:0; color:#333; text-align:left;">

                                            <i ng-if="current.Exam && current.Exam.Lock"
                                               style="min-width: 14px;"
                                               class="fa fa-lock"></i>
                                            <i ng-if="current.Exam && current.Exam.Permission == 'Read' && !current.Exam.Lock"
                                               style="min-width: 14px;"
                                               class="fa fa-ban"></i>
                                            <i ng-if="current.Exam && current.Exam.Permission == 'Editor' && !current.Exam.Lock && current.Exam.Type == 'Program'"
                                               style="min-width: 14px;"
                                               class="fa fa-cogs"></i>
                                            <i ng-if="current.Exam && current.Exam.Permission == 'Editor' && !current.Exam.Lock && current.Exam.Type !== 'Program'"
                                               style="min-width: 14px;"
                                               class="fa fa-edit"></i>
                                            {{current.Exam?current.Exam.Name:'請選擇'}}
                                            <span ng-if="current.mode == modeList[0]"
                                                  class="caret"></span>
                                        </a>
                                        <ul ng-if="current.mode == modeList[0]"
                                            class="dropdown-menu"
                                            style="width:100%;">
                                            <li ng-repeat="examItem in examList | filter: filterPermission"
                                                ng-class="{active:examItem==current.Exam}">
                                                <a href="javascript:;"
                                                   ng-click="setCurrent(current.Student, examItem, false, true)">
                                                    <i ng-if="examItem.Lock"
                                                       style="min-width: 14px;"
                                                       class="fa fa-lock"></i>
                                                    <i ng-if="examItem.Permission == 'Read' && !examItem.Lock"
                                                       style="min-width: 14px;"
                                                       class="fa fa-ban"></i>
                                                    <i ng-if="examItem.Permission == 'Editor' && !examItem.Lock && examItem.Type == 'Program'"
                                                       style="min-width: 14px;"
                                                       class="fa fa-cogs"></i>
                                                    <i ng-if="examItem.Permission == 'Editor' && !examItem.Lock && examItem.Type !== 'Program'"
                                                       style="min-width: 14px;"
                                                       class="fa fa-edit"></i>
                                                    {{examItem.Name}}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-if="current.Exam.Type != 'Text'">
                                <td style="position:relative;">
                                    <span>{{current.Exam ? current.Exam.SubName || current.Exam.Name : ''}}</span>
                                </td>
                                <td ng-if="current.Exam && current.Student">
                                    <div ng-if="current.Exam.Lock || !current.Student || current.Exam.Type == 'Program' || current.Exam.Permission !== 'Editor'"
                                         class="text-center"
                                         score-stress="{{current.Student[current.Exam.ExamID]}}"
                                         score-background="none">
                                        {{current.Student[current.Exam.ExamID] == '0' ? ('0') : (current.Student[current.Exam.ExamID] || '&nbsp;')}}
                                    </div>
                                    <div ng-if="!current.Exam.Lock && current.Student && current.Exam.Type == 'Number' && current.Exam.Permission == 'Editor'"
                                         class="input-group">
                                        <input ng-model="current.Value"
                                               ng-keydown="enterGrade($event)"
                                               type="text"
                                               class="form-control pg-grade-textbox"
                                               placeholder="{{isMobile?'':'Enter送出'}}"
                                               select-on-click />
                                        <span class="input-group-btn">
                                            <a class="btn btn-default"
                                               ng-click="enterGrade()">
                                                送出
                                            </a>
                                        </span>
                                    </div>
                                </td>
                                <td ng-if="!current.Exam || !current.Student"
                                    class="text-center">
                                    --
                                </td>
                            </tr>
                            <!--文字評量輸入-->
                            <tr ng-if="current.Exam.Type == 'Text'">
                                <td ng-if="current.Exam && current.Student"
                                    colspan="2">
                                    <div ng-if="!current.Exam.Lock && current.Exam.Type == 'Text' && current.Exam.Permission == 'Editor'"
                                         class="input-group">
                                        <!--文字輸入區域-->
                                        <textarea ng-model="current.Value"
                                                  ng-keydown="enterGrade($event)"
                                                  maxlength="200"
                                                  placeholder="{{isMobile?'':'Enter送出'}}"
                                                  style="min-height: 60px;height:120px;resize: vertical; "
                                                  type="text"
                                                  class="form-control pg-grade-textbox ng-scope ng-pristine ng-valid"
                                                  select-on-click>
                                        </textarea>
                                        <div class="pull-right">
                                            <span class="input-group-btn">
                                                <a ng-click="openCommentCode()"
                                                   class="btn btn-default">
                                                    <i class="far fa-file-code">
                                                        文字代碼表
                                                    </i>
                                                </a>
                                            </span>
                                            <span class="input-group-btn">
                                                <a 
                                                ng-click="enterGrade()"
                                                   class="btn btn-default">
                                                    送出
                                                </a>
                                            </span>
                                        </div>
                                    </div>
                                    <div ng-if="current.Exam.Lock && current.Exam.Permission == 'Editor'">
                                        &nbsp
                                    </div>
                                </td>
                                <td ng-if="!current.Exam || !current.Student"
                                    colspan="2"
                                    class="text-center">
                                    --
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!--努力程度對照表 -->
                    <table class="table table-bordered table-striped"
                           style="width:260px;">
                        <thead>
                            <tr>
                                <th class="text-center"
                                    colspan="3">努力程度對照表</th>
                            </tr>
                            <tr>
                                <th class="text-center"
                                    style="width:50px;">分數</th>
                                <th class="text-center"
                                    style="width:50px;">努力程度</th>
                                <th class="text-center">文字描述</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="effortItem in effortPairList">
                                <td class="text-center"
                                    style="padding:0px;">{{effortItem.Score}} </td>
                                <td class="text-center"
                                    style="padding:0px;">{{effortItem.Code}}</td>
                                <td class="text-center"
                                    style="padding:0px;">{{effortItem.Name}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--成績管理Table-->
            <div ng-if="current.mode == modeList[0]"
                 style="margin-right:270px;">
                <table class="table table-bordered table-striped table-hover text-center"
                       style="table-layout:fixed;">
                    <thead>
                        <tr>
                            <th class="text-center"
                                rowspan="2">
                                班級
                            </th>
                            <th class="text-center"
                                rowspan="2">
                                座號
                            </th>
                            <th class="text-center"
                                rowspan="2">
                                姓名
                            </th>
                            <th ng-if="!exam.Group || exam.SubVisible"
                                ng-repeat="exam in examList | filter: filterPermission"
                                ng-click="showSubExam(exam)"
                                class="text-center"
                                style = "{{exam.Group?'padding: 8px 2px;border: none':'padding: 8px 2px;'}}"
                                rowspan="{{exam.Group?1:2}}">
                                <span ng-if="!exam.Group"
                                      style="max-height:60px;display:inline-block;overflow:hidden;text-overflow:ellipsis;">
                                    {{exam.Name}} <span ng-if="exam.Percentage.length > 0"
                                          class="text-blue">({{exam.Percentage}})</span>
                                </span>
                                <span ng-if="exam.Name == '平時評量'"
                                      style="max-height:60px;display:inline-block;overflow:hidden;text-overflow:ellipsis; padding-left:5px;">
                                </span>
                                <span ng-if="exam.Group"></span>
                            </th>
                        </tr>
                        <tr>
                            <th ng-repeat="exam in examList | filter: filterPermission"
                                ng-if="exam.Group && exam.SubVisible"
                                class="text-center"
                                style="padding: 8px 2px;">
                                <h6 style="max-height:40px;display:inline-block;overflow:hidden;text-overflow:ellipsis;margin: 0px;">
                                    {{exam.Name}}
                                </h6>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="stuRec in studentList"
                            ng-class="{'warning':stuRec.StudentID == current.Student.StudentID}"
                            style="cursor:pointer;">
                            <!-- <td ng-click="setCurrent(stuRec, current.Exam, true, true)"
                                class="text-left"
                                ng-class="{'boy':stuRec.Gender == '男' ,'girl': stuRec.Gender == '女'}">
                                <span ng-if="stuRec.SeatNo"
                                      style="min-width:24px;display:inline-block;">{{stuRec.SeatNo}}.&nbsp;</span>
                                <span>{{stuRec.StudentName}}</span>
                            </td> -->
                            <td ng-click="setCurrent(stuRec, current.Exam, true, true)"
                                class="text-center"
                                ng-class="{'boy':stuRec.Gender == '男' ,'girl': stuRec.Gender == '女'}">

                                <span>{{stuRec.ClassName}}</span>
                            </td>
                            <td ng-click="setCurrent(stuRec, current.Exam, true, true)"
                                class="text-center"
                                ng-class="{'boy':stuRec.Gender == '男' ,'girl': stuRec.Gender == '女'}">

                                <span>{{stuRec.SeatNo}}</span>
                            </td>
                            <td ng-click="setCurrent(stuRec, current.Exam, true, true)"
                                class="text-center"
                                ng-class="{'boy':stuRec.Gender == '男' ,'girl': stuRec.Gender == '女'}">

                                <span>{{stuRec.StudentName}}</span>
                            </td>
                            <td ng-repeat="exam in examList | filter: filterPermission"
                                class="text-center"
                                ng-class="{'isCurrent':stuRec.IsCurrent&&stuRec.CurrentExam==exam.ExamID }" 
                                style="position:relative;"
                                ng-if="!exam.Group || exam.SubVisible"
                                ng-click="setCurrent(stuRec, exam, true, true)">
                                <div ng-if="!checkOneCell(stuRec, exam.ExamID)"
                                     ng-attr-title="資料已修改，尚未儲存! {{stuRec[exam.ExamID + 'Origin'] ? '原值為：'+stuRec[exam.ExamID+'Origin']:''}}"
                                     style="display:inline-block;background-color:red;position:absolute;left:3px;top:3px;width:5px;height:6px;border-radius:5px;">
                                </div>
                                <h6 ng-if="exam.Group"
                                    style="margin:0px;display:inline-block;">
                                    <small>
                                        <span style="overflow:hidden;width:100%;display:inline-block;white-space:nowrap"
                                              score-stress="{{stuRec[exam.ExamID]}}"
                                              data-score-type="{{exam.Type}}"
                                              data-score-name="{{exam.Name}}">
                                            {{stuRec[exam.ExamID]}}
                                        </span>
                                    </small>
                                </h6>

                                <span ng-if="!exam.Group"
                                      score-stress="{{stuRec[exam.ExamID]}}"
                                      data-score-type="{{exam.Type}}"
                                      data-score-name="{{exam.Name}}"
                                      style="overflow:hidden;width:100%;display:inline-block;white-space:nowrap">
                                    {{stuRec[exam.ExamID]}}
                                </span>

                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!--平時評量Table-->
            <div ng-if="current.mode == modeList[1]"
                 style="margin-right:270px;">
                <table class="table table-bordered table-striped table-hover text-center"
                       style="table-layout:fixed;">
                    <thead>
                        <tr>
                            <th colspan="3"
                                class="text-center">基本資料</th>
                            <th colspan="2"
                                class="text-center">平時評量成績</th>
                            <th colspan="{{gradeItemList.length}}"
                                class="text-center">平時評量項目</th>
                        </tr>
                        <tr>
                            <th class="text-center">
                                班級
                            </th>
                            <th class="text-center">
                                座號
                            </th>
                            <th class="text-center">
                                姓名
                            </th>
                            <th class="text-center">
                                成績
                            </th>
                            <th class="text-center">
                                努力程度
                            </th>
                            <th ng-repeat="item in gradeItemList"
                                class="text-center">{{item.Name}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="student in studentList"
                            ng-class="{'warning':student.StudentID == current.Student.StudentID}"
                            style="cursor:pointer;">
                            <td ng-click="setCurrent(student, current.Exam, true, true)">
                                {{student.ClassName}}
                              
                            </td>
                            <td ng-click="setCurrent(student, current.Exam, true, true)">{{student.SeatNumber}}</td>
                            <td ng-click="setCurrent(student, current.Exam, true, true)">{{student.StudentName}}</td>
                            <td class="text-center"
                                style="position:relative;"
                                ng-click="setCurrent(student, item, true, true)"
                                score-stress="{{student['QuizResult']}}"
                                data-score-type="{{current.Exam.Type}}"
                                data-score-name="{{current.Exam.Name}}">

                                <div ng-if="!checkOneCell(student, 'QuizResult')"
                                     style="display:inline-block;background-color:red;position:absolute;left:3px;top:3px;width:5px;height:6px;border-radius:5px;">
                                </div>
                                {{student['QuizResult']}}
                            </td>
                            <td class="text-center"
                                style="position:relative;"
                                ng-click="setCurrent(student, item, true, true)">
                                <div ng-if="!checkOneCell(student, 'QuizResult_努力程度')"
                                     style="display:inline-block;background-color:red;position:absolute;left:3px;top:3px;width:5px;height:6px;border-radius:5px;">
                                </div>
                                {{student['QuizResult_努力程度']}}
                            </td>
                            <td 
                                 ng-repeat="item in gradeItemList"
                                 ng-class="{'isCurrent':student.IsCurrent&&student.CurrentExam==item.ExamID }" 
                                class="text-center"
                                style="position:relative;"
                                ng-click="setCurrent(student, item, true, true)">
                                <div ng-if="!checkOneCell(student, item.ExamID)"
                                     ng-attr-title="資料已修改，尚未儲存! {{student[item.ExamID + 'Origin']?'原值為：'+ student[item.ExamID + 'Origin']:''}}"
                                     style="display:inline-block;background-color:red;position:absolute;left:3px;top:3px;width:5px;height:6px;border-radius:5px;">
                                </div>
                                <span score-stress="{{student[item.ExamID]}}"
                                      data-score-type="{{current.Exam.Type}}"
                                     
                                      style="overflow:hidden;width:100%;display:inline-block;white-space:nowrap">
                                    {{student[item.ExamID]}}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!--匯入畫面-->
    <div id="importModal"
         class="modal fade"
         tabindex="-1"
         role="dialog"
         aria-labelledby="importModal">
        <div class="modal-dialog modal-lg"
             role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">{{batchItem.Name}}</h4>
                </div>
                <div class="modal-body"
                     ng-if="!batchItem.ParseValues">
                    <div style="margin:15px 0px;">
                        <span>使用說明</span>
                        <ol class="">
                            <li>
                                <span>從excel中複製成績</span>
                                <ul>
                                    <li class="text-danger">請先確認excel中學生的人數及順序皆與系統相符</li>
                                    <li class="text-danger">複製成績時，僅需圈選成績的部分，不含學生姓名及表頭</li>
                                    <li class="text-danger">如有學生沒有成績資料，請輸入"-"，表示無資料，否則系統將認定錯誤</li>
                                </ul>
                            </li>
                            <li>於下方文字方塊中貼上</li>
                            <li>使用"解析"按鈕，進行解析</li>
                            <li>預覽資料確認成績正確</li>
                            <li>
                                <span>使用"匯入"按鈕，進行匯入</span>
                                <ul>
                                    <li class="text-danger">如果輸入資料有錯誤，將無法匯入</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                    <div class="row"
                         style="margin:20px 0px;">
                        <textarea class="col-xs-12"
                                  rows="5"
                                  ng-model="batchItem.ParseString" 
                                  ></textarea>
                    </div>
                </div>
                <div class="modal-body"
                     ng-if="batchItem.ParseValues">
                    <p>預覽</p>
                    <div class="row">
                        <div class="visible-md visible-lg">
                            <div class="col-md-3"
                                 ng-repeat="col in [1,2,3,4]">
                                <div ng-repeat="stuRec in studentList"
                                     ng-if="$index < studentList.length*col/4 && $index >= studentList.length*(col-1)/4">
                                    <div class="importStudentPreview"
                                         >
                                        <span class="studentInfo">
                                            <span ng-if="stuRec.SeatNo"
                                                  style="min-width:24px;display:inline-block;">{{stuRec.SeatNo}}.&nbsp;</span>
                                            <span>{{stuRec.StudentName}}</span>
                                        </span>
                                        <div ng-if="batchItem.ParseValues[$index]=='錯誤'"
                                             class="pull-right label label-danger"
                                             style="font-size:inherit;">錯誤</div>
                                        <div ng-if="batchItem.ParseValues[$index]===''"
                                             class="pull-right text-danger">--
                                        </div>
                                        <div ng-if="batchItem.ParseValues[$index]!='錯誤' && batchItem.ParseValues[$index]!==''"
                                             class="pull-right"
                                             ng-class="{'text-danger':batchItem.ParseValues[$index] < 60}">
                                            {{batchItem.ParseValues[$index]}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="visible-sm">
                            <div class="col-sm-4"
                                 ng-repeat="col in [1,2,3]">
                                <div ng-repeat="stuRec in studentList"
                                     ng-if="$index < studentList.length*col/3 && $index >= studentList.length*(col-1)/3">
                                    <div class="importStudentPreview">
                                        <span class="studentInfo">
                                            <span ng-if="stuRec.SeatNo"
                                                  style="min-width:24px;display:inline-block;">{{stuRec.SeatNo}}.&nbsp;</span>
                                            <span>{{stuRec.StudentName}}</span>
                                        </span>
                                        <div ng-if="batchItem.ParseValues[$index]=='錯誤'"
                                             class="pull-right label label-danger"
                                             style="font-size:inherit;">錯誤</div>
                                        <div ng-if="batchItem.ParseValues[$index]===''"
                                             class="pull-right text-danger">--
                                        </div>
                                        <div ng-if="batchItem.ParseValues[$index]!='錯誤' && batchItem.ParseValues[$index]!==''"
                                             class="pull-right"
                                             ng-class="{'text-danger':batchItem.ParseValues[$index] < 60}">
                                            {{batchItem.ParseValues[$index]}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="visible-xs">
                            <div class="col-xs-6"
                                 ng-repeat="col in [1,2]">
                                <div ng-repeat="stuRec in studentList"
                                     ng-if="$index < studentList.length*col/2 && $index >= studentList.length*(col-1)/2">
                                    <div class="importStudentPreview">
                                        <span class="studentInfo">
                                            <span ng-if="stuRec.SeatNo"
                                                  style="min-width:24px;display:inline-block;">{{stuRec.SeatNo}}.&nbsp;</span>
                                            <span>{{stuRec.StudentName}}</span>
                                        </span>
                                        <div ng-if="batchItem.ParseValues[$index]=='錯誤'"
                                             class="pull-right label label-danger"
                                             style="font-size:inherit;">錯誤</div>
                                        <div ng-if="batchItem.ParseValues[$index]===''"
                                             class="pull-right text-danger">--
                                        </div>
                                        <div ng-if="batchItem.ParseValues[$index]!='錯誤' && batchItem.ParseValues[$index]!==''"
                                             class="pull-right"
                                             ng-class="{'text-danger':batchItem.ParseValues[$index] < 60}">
                                            {{batchItem.ParseValues[$index]}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-default btn-sm"
                            ng-if="!batchItem.ParseValues"
                            data-dismiss="modal">取消</button>
                    <button type="button"
                            class="btn btn-primary btn-sm"
                            ng-if="!batchItem.ParseValues"
                            ng-click="batchItem.Parse()">解析</button>
                    <button type="button"
                            class="btn btn-default btn-sm"
                            ng-if="batchItem.ParseValues"
                            ng-click="batchItem.Clear()">返回</button>
                    <button type="button"
                            class="btn btn-primary btn-sm"
                            ng-if="batchItem.ParseValues"
                            ng-click="batchItem.Import()"
                            ng-class="{disabled:batchItem.HasError}">匯入</button>
                </div>
            </div>
        </div>
    </div>
    <!--編輯評分項目-->
    <div id="editScoreItemModal"
         class="modal fade in"
         tabindex="-1"
         role="dialog"
         aria-labelledby="editScoreItem">
        <div class="modal-dialog modal-lg"
             role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h1>平時評量設定</h1>
                    <h4>{{current.Course.CourseName}}</h4>
                </div>
                <div class="modal-body">
                    <table ng-if="gradeItemConfig.Mode == 'Editor'"
                           class="table table-bordered table-striped table-hover text-center"
                           style="table-layout:fixed;">
                        <thead>
                            <tr>
                                <th class="text-center"
                                    style="padding: 8px 2px;">評分名稱</th>
                                <th class="text-center"
                                    style="padding: 8px 2px;">權重</th>
                                <th class="text-center"
                                    style="padding: 8px 2px;">刪除</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="item in gradeItemConfig.Item">
                                <td class="text-center"
                                    style="position:relative; padding:0px">
                                    <div style="white-space: nowrap;overflow: hidden;">
                                        <input ng-if="!item.isNewOne" ng-model="item.Name"
                                               type="text"
                                               class="form-control pg-grade-textbox ng-pristine ng-valid"
                                               select-on-click=""
                                               readonly>
                                    <!-- 如果是新項目 -->
                                        <input ng-if="item.isNewOne" ng-model="item.Name"
                                               type="text"
                                               class="form-control pg-grade-textbox ng-pristine ng-valid"
                                               select-on-click=""
                                        >
                                    </div>
                                </td>
                                <td class="text-center"
                                    style="position:relative; padding:0px">
                                    <div style="white-space: nowrap;overflow: hidden;">
                                        <input ng-model="item.Weight"
                                               type="text"
                                               class="form-control pg-grade-textbox ng-pristine ng-valid"
                                               select-on-click="">
                                    </div>
                                </td>
                                <td style="padding:0px">
                                    <div style="white-space: nowrap;overflow: hidden;">
                                        <a style="height:100%;width: 100%"
                                           ng-click="gradeItemConfig.DeleteItem(item)"
                                           class="btn btn-default">
                                            <i class="fa fa-minus-square"></i>
                                            刪除
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0px"
                                    colspan="3">
                                    <div style="white-space: nowrap;overflow: hidden;">
                                        <a style="height:100%;width: 100%"
                                           ng-click="gradeItemConfig.AddItem()"
                                           class="btn btn-default">
                                            <i class="fa fa-plus-square"></i>
                                            加入項目
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <textarea ng-if="gradeItemConfig.Mode=='JSON'"
                              ng-model="gradeItemConfig.JSONCode"
                              style="min-height: 360px;resize: vertical;word-wrap: normal;white-space: nowrap ;background: pink;"
                              type="text"
                              class="form-control pg-grade-textbox ng-scope ng-pristine ng-valid">
                    </textarea>
                    <span style ="color: #af3939 ;">如欲刪除評分項目,請先匯出成績做備份。

                    </span>
                    <span style ="color: #af3939 ;">評量項目新增後,名稱將無法修改。

                    </span>
                </div>
                
             
                <div class="modal-footer">
                    <!-- <a ng-if="gradeItemConfig.Mode=='Editor'"
                       ng-click="gradeItemConfig.JSONMode()"
                       class="btn btn-link pull-left ng-scope">
                       編輯子評量樣版
                    </a>
                    <a ng-if="gradeItemConfig.Mode=='JSON'"
                       ng-click="gradeItemConfig.CommitJSON()"
                       class="btn btn-link pull-left ng-scope">
                       預灠編輯結果
                    </a> -->
                    <a class="btn btn-link pull-left ng-scope"
                       ng-click="openCopyModal()"
                       ng-disabled="current.gradeItemList.length < 2">
                        複製評量至其他課程
                    </a>
                    <!-- <a ng-click="saveGradeItemConfig()"
                       class="btn btn-default ng-scope"
                       ng-class="{'btn-danger': !gradeItemConfig.CheckConfig()}">
                        <i class="fa fa-floppy-o"></i>
                        儲存 
                    </a> -->
                    <a ng-click="saveGradeItemConfigAndScoreData()"
                    class="btn btn-default ng-scope"
                    ng-class="{'btn-danger': !gradeItemConfig.CheckConfig()}">
                     <i class="fa fa-floppy-o"></i>
                     儲存 
                 </a>
                </div>
            </div>
        </div>
    </div>
    <!--文字代碼表-->
    <div id="textCodeModal"
         class="modal fade in"
         tabindex="-1"
         role="dialog"
         aria-labelledby="editScoreItem">
        <div class="modal-dialog modal-lg"
             role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3>文字代碼表</h3>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-striped table-hover text-center"
                           style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th class="text-center"
                                    style="width:120px;">
                                    <div class="btn-group btn-block">
                                        <a href="javascript:void(0)"
                                           class="btn btn-link btn-block dropdown-toggle"
                                           data-toggle="dropdown"
                                           style="padding:0; color:#333; text-align:left;">

                                            {{current.TextCatalog?current.TextCatalog:'分類'}}
                                            <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu"
                                            style="width:100%;">
                                            <li ng-repeat="catalogItem in examCatalogList"
                                                ng-class="{active:catalogItem==current.TextCatalog}">
                                                <a href="javascript:;"
                                                   ng-click="current.TextCatalog=catalogItem">
                                                    {{catalogItem}}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </th>
                                <th class="text-center"
                                    style="width:100px;">代碼</th>
                                <th class="text-center">詳細內容</th>
                                <!-- <th>代碼</th>
                                <th>詳細內容</th> -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="ext in examTextList | filter: filterTextCatalog"
                                style="cursor:pointer;"
                                ng-click="selectCode(ext)"
                                ng-class="{'text-danger': ext.Selected}">
                                <th>{{ext.Catalog}}</th>
                                <td>{{ext.Code}}</td>
                                <td>{{ext.Content}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer"></div>
            </div>
        </div>
    </div>
    <!-- 複製評量 -->
    <div class="modal fade"
         id="copyModal"
         tabindex="-1"
         role="dialog"
         aria-labelledby="copyLabel"
         aria-hidden="true">
        <div class="modal-dialog"
             role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"
                        id="copyLabel">將複製評量項目至下列勾選課程</h4>
                    <h6 style="color: red;">已有評分項目無法勾選</h6>
                </div>
                <div class="modal-body">
                    <div class="form-check"
                         ng-repeat="course in CanSelectCourseExamList">
                        <input class="form-check-input"
                               type="checkbox"
                               ng-model="course.Selected"
                               ng-disabled="course.ItemDisable"
                               value=""
                               id="{{course.CourseID}}">
                        <label class="form-check-label"
                               for="{{course.CourseID}}">
                            {{course.CourseName}}
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- data-dismiss="modal" -->
                    <button type="button"
                            class="btn btn-secondary"
                            ng-click="closeCopyModal()">關閉</button>
                    <button type="button"
                            class="btn btn-primary"
                            ng-click="copyGradeItemConfig()">儲存</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 複製評量儲存成功 -->
    <div class="modal fade"
         id="saveSuccessModal"
         tabindex="-1"
         role="dialog"
         aria-labelledby="successLabel"
         aria-hidden="true">
        <div class="modal-dialog"
             role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"
                        id="successLabel">複製成功</h4>
                </div>
                <div class="modal-body">
                    已將「{{current.Course.CourseName}}」此課程平時評量項目複製到選擇的課程。
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>