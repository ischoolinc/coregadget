<div class="mx-8 mb-8">
  <p class="gadget_bigtitle pt-10">全校學生管理</p>
  <div *ngIf="loading" class="text-center">資料載入中...</div>
  <div *ngIf="!loading">
    <div class="mt-6">
      <div class="flex flex-col items-stretch md:flex-row md:items-center md:justify-end">
        <button class="btn btn-primary rounded-full mt-2 md:mt-0 md:mr-2" (click)="addStudent()">
          <span class="pr-1">新增學生</span>
          <span class="iconify text-2xl" data-icon="fluent:add-circle-16-regular" data-inline="false"></span>
        </button>
        <button class="btn btn-primary rounded-full mt-2 md:mt-0 md:mr-2" (click)="importStudent()">
          <span class="pr-1">匯入名單</span>
          <span class="iconify text-2xl" data-icon="uil:import" data-inline="false"></span>
        </button>
        <button class="btn btn-primary rounded-full mt-2 md:mt-0 md:mr-auto" (click)="exportStudent()">
          <span class="pr-1">匯出名單</span>
          <span class="iconify text-2xl" data-icon="uil:export" data-inline="false"></span>
        </button>
      </div>
    </div>
    <div class="grid grid-cols-12 gap-x-4 gap-y-6 mt-6">
      <aside class="hidden lg:block lg:col-span-2 grid-limit-height">
        <ng-container *ngTemplateOutlet="tplClass"></ng-container>
      </aside>
      <div class="col-span-12 md:col-span-7 lg:col-span-6">
        <ng-container *ngTemplateOutlet="tplStudents"></ng-container>
      </div>
      <div class="hidden md:block md:col-span-5 lg:col-span-4 grid-limit-height">
        <ng-container *ngTemplateOutlet="tplStudentInfo"></ng-container>
        <ng-container *ngTemplateOutlet="tplParentInfo"></ng-container>
      </div>
    </div>
  </div>
</div>

<ng-template #tplClass>
  <nav class="nav">
    <ul>
      <li *ngFor="let gradeYear of sm.getGradeYearList()">
        <button (click)="gradeYear.open = !gradeYear.open"
          class="btn inline-flex items-center rounded text-left font-semibold px-2">
          <svg fill="currentColor"
            class="transition-transform duration-200 transform mr-2 -mt-1"
            [ngClass]="{'rotate-90': gradeYear.open, 'rotate-360': !gradeYear.open}"
            xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="20" height="20" preserveAspectRatio="xMidYMid meet" viewBox="0 0 20 20"><path fill="#4f4f4f" d="M10 19a1 1 0 0 1-.64-.23a1 1 0 0 1-.13-1.41L13.71 12L9.39 6.63a1 1 0 0 1 .15-1.41a1 1 0 0 1 1.46.15l4.83 6a1 1 0 0 1 0 1.27l-5 6A1 1 0 0 1 10 19z"/></svg>
          <span>{{gradeYear.title ? gradeYear.title + '年級' : '未分年級'}} ({{sm.getCradeYearStudentCount(gradeYear.title)}})</span>
        </button>
        <div [hidden]="!gradeYear.open" class="ml-8">
          <ul>
            <li *ngFor="let item of sm.getGradeYearClassList(gradeYear.title)">
              <a href="javascript:;"
                (click)="sm.curClass$.next(item)"
                class="mt-2 rounded inline-flex p-2"
                [ngClass]="{'bg-gray-lightest': sm.curClass$.value.ClassId === item.ClassId}">
                <span>{{item.ClassName || '未分班級'}} ({{item.Students.length}})</span>
            </a>
            </li>
          </ul>
        </div>
      </li>
    </ul>
  </nav>
</ng-template>

<ng-template #tplStudents>
  <div>
    <app-search-bar
      #keyword
      class="flex-1"
      placeHolder="輸入學生姓名、學號、登入帳號、代碼"
      [formControl]="keywordCtrl"
      (onClear)="keywordCtrl.setValue('')"
    ></app-search-bar>
  </div>
  <div class="grid-limit-height">
    <table class="table table-striped table-hover mt-4">
      <thead>
        <tr>
          <th>學生姓名</th>
          <th class="rounded-tr-md md:rounded-none">班級</th>
          <th class="hidden md:table-cell md:rounded-tr-md xl:rounded-none">學號</th>
          <th class="hidden xl:table-cell xl:rounded-tr-md 2xl:rounded-none">代碼</th>
          <th class="hidden 2xl:table-cell">帳號</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filterStudents" (click)="selectedStudent(item)"
          [ngClass]="{'action': curStudent?.StudentId === item.StudentId}">
          <td><p class="text-line-clamp">{{item.StudentName}}</p></td>
          <td>{{item.ClassName}}</td>
          <td class="hidden md:table-cell">{{item.StudentNumber}}</td>
          <td class="hidden xl:table-cell">{{item.StudentCode}}</td>
          <td class="hidden 2xl:table-cell">{{item.LinkAccount}}</td>
        </tr>
      </tbody>
    </table>
    <p class="text-warning" *ngIf="studentErrMsg">{{studentErrMsg}}</p>
    <p class="text-center" *ngIf="!filterStudents?.length">目前無資料</p>
  </div>
</ng-template>

<ng-template #tplStudentInfo>
  <div>
    <div class="flex items-center justify-start mb-4">
      <div class="border-2 border-primary h-11 mr-4 rounded-full"></div>
      <div class="flex items-center justify-between w-full">
        <div>學生資訊</div>
        <button [disabled]="!curStudent.StudentId"
          class="btn btn-secondary rounded"
          (click)="editStudent()">
          編輯</button>
      </div>
    </div>
    <div>
      <table class="table table-striped table-sm">
        <colgroup>
          <col class="w-1/4">
        </colgroup>
        <tbody>
          <tr>
            <th>學生系統編號</th>
            <td>{{curStudent.StudentId}}</td>
          </tr>
          <tr>
            <th>學生姓名</th>
            <td>{{curStudent.StudentName}}</td>
          </tr>
          <tr>
            <th>年級</th>
            <td>{{curStudent.GradeYear}}</td>
          </tr>
          <tr>
            <th>班級</th>
            <td>{{curStudent.ClassName}}</td>
          </tr>
          <tr>
            <th>性別</th>
            <td>{{curStudent.Gender}}</td>
          </tr>
          <tr>
            <th>座號</th>
            <td>{{curStudent.SeatNo}}</td>
          </tr>
          <tr>
            <th>學號</th>
            <td>{{curStudent.StudentNumber}}</td>
          </tr>
          <tr>
            <th>登入帳號</th>
            <td>{{curStudent.LinkAccount}}</td>
          </tr>
          <tr>
            <th>學生代碼</th>
            <td>{{curStudent.StudentCode}}</td>
          </tr>
          <tr>
            <th>家長代碼</th>
            <td>{{curStudent.ParentCode}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ng-template>
<ng-template #tplParentInfo>
  <div class="mt-6">
    <div class="flex items-center justify-start mb-4">
      <div class="border-2 border-primary h-11 mr-4 rounded-full"></div>
      <div class="flex items-center justify-between w-full">
        <div>家長資訊</div>
        <button [disabled]="!curStudent.StudentId"
          class="btn btn-secondary rounded"
          (click)="joinParent()">
          新增</button>
      </div>
    </div>
    <div>
      <table class="table table-striped table-sm table-hover">
        <thead>
          <tr>
            <th>姓名</th>
            <th>稱謂</th>
            <th>帳號</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of parentList" (click)="editParent(item)">
            <td>{{item.LastName}}{{item.FirstName}}</td>
            <td>{{item.RelationName}}</td>
            <td>{{item.LinkAccount}}</td>
          </tr>
        </tbody>
      </table>
      <p class="text-warning" *ngIf="parentErrMsg">{{parentErrMsg}}</p>
    </div>
  </div>
</ng-template>
